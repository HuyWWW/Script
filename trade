repeat task.wait() until game:IsLoaded()
repeat task.wait() until game:GetService("Players").LocalPlayer

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local plr = Players.LocalPlayer

-- Retry loading ClientData safely
local ClientData
repeat
    local success, result = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData)
    end)
    if success then
        ClientData = result
    else
        warn("--> [System] ClientData chưa sẵn sàng, thử lại sau 1s...")
        task.wait(3)
    end
until ClientData

getgenv().Config = {
    Inventory = {"pets"}, 
    Username = {"Natali3Rippl3", "umaVividStarry" , "MrsThomas_pin3"},
    Pet = {"winter_2025_xmas_tree_sasquatch", "winter_2025_christmas_spirit"},
    Noen = false,
    Mega_Neon = true,
    Kick_After_Trade = true
}

getgenv().Kick_After_Trade = getgenv().Config.Kick_After_Trade

function RE(RemoteName)
    local router = require(game:GetService("ReplicatedStorage").ClientModules.Core.RouterClient.RouterClient)
    local remote = router.get(RemoteName)
    if not remote then
        warn("--> [Error] Không tìm thấy Remote: " .. tostring(RemoteName))
    end
    return remote
end

local SendTradeRequest = RE("TradeAPI/SendTradeRequest")
local AddItemToOffer = RE("TradeAPI/AddItemToOffer")
local AcceptNegotiation = RE("TradeAPI/AcceptNegotiation")
local ConfirmTrade = RE("TradeAPI/ConfirmTrade")

local function writeCompletionFile(username)
    local completionFile = "Completed.txt"
    local fileWritten = false
    local attempts = 0
    local MAX_WRITE_ATTEMPTS = 15
    
    repeat
        attempts = attempts + 1
        local success, err = pcall(function()
            -- Đọc file hiện tại (nếu có)
            local existingContent = ""
            local readSuccess, content = pcall(readfile, completionFile)
            if readSuccess then
                existingContent = content
            end
            
            -- Kiểm tra xem username đã có trong file chưa
            local lines = {}
            for line in existingContent:gmatch("[^\r\n]+") do
                table.insert(lines, line)
            end
            
            local alreadyExists = false
            for _, line in ipairs(lines) do
                -- Trim whitespace từ đầu và cuối dòng
                local trimmedLine = line:gsub("^%s+", ""):gsub("%s+$", "")
                if trimmedLine == username then
                    alreadyExists = true
                    break
                end
            end
            
            -- Nếu chưa có thì thêm vào
            if not alreadyExists then
                local newContent = existingContent
                if newContent ~= "" and not newContent:match("\n$") and not newContent:match("\r$") then
                    newContent = newContent .. "\n"
                end
                newContent = newContent .. username
                writefile(completionFile, newContent)
                task.wait(0.1) -- Đợi một chút để file được flush
            else
                -- Đã có rồi thì coi như thành công
                fileWritten = true
                return
            end
        end)
        
        if success then
            task.wait(0.3) -- Đợi file được flush trước khi verify
            -- Verify: đọc lại file để check (retry nếu cần)
            local verifySuccess = false
            for verifyAttempt = 1, 3 do
                local readSuccess, content = pcall(readfile, completionFile)
                if readSuccess and content and content:find(username, 1, true) then
                    verifySuccess = true
                    fileWritten = true
                    print("--> [Completion] Đã thêm username vào comple.txt: " .. username)
                    break
                end
                if verifyAttempt < 3 then
                    task.wait(0.2) -- Đợi một chút rồi thử lại
                end
            end
            
            if not verifySuccess then
                warn("--> [Completion] Write thành công nhưng không verify được (lần " .. attempts .. ")")
            end
        else
            warn("--> [Completion] Lỗi write file (lần " .. attempts .. "): " .. tostring(err))
        end
        
        if not fileWritten and attempts < MAX_WRITE_ATTEMPTS then
            task.wait(0.5)
        end
    until fileWritten or attempts >= MAX_WRITE_ATTEMPTS
    
    -- Nếu vẫn chưa write được, cố gắng write một lần cuối đơn giản
    if not fileWritten then
        warn("--> [Warning] Không thể ghi vào comple.txt sau " .. MAX_WRITE_ATTEMPTS .. " lần thử. Thử lần cuối...")
        pcall(function()
            local readSuccess, content = pcall(readfile, completionFile)
            local newContent = content or ""
            if newContent ~= "" and not newContent:match("\n$") then
                newContent = newContent .. "\n"
            end
            newContent = newContent .. username
            writefile(completionFile, newContent)
            print("--> [Completion] Đã cố gắng write lần cuối (không verify)")
        end)
    end
end

local function getTradeablePets()
    local success, data = pcall(function()
        return ClientData.get_data()[plr.Name]
    end)
    
    if not success or not data or not data.inventory or not data.inventory.pets then
        warn("--> [Warning] Không load được inventory hoặc inventory rỗng.")
        return {}
    end

    local pets = {}
    for unique_id, pet_info in pairs(data.inventory.pets) do
        local isTargetPet = false
        for _, targetId in ipairs(getgenv().Config.Pet) do
            if pet_info.id == targetId then
                isTargetPet = true
                break
            end
        end

        if isTargetPet then
            -- Ưu tiên Mega_Neon trước
            if getgenv().Config.Mega_Neon == true then
                if pet_info.properties and pet_info.properties.mega_neon == true then
                    table.insert(pets, unique_id)
                end
            -- Nếu không phải Mega_Neon, check Neon
            elseif getgenv().Config.Noen == true then
                if pet_info.properties and pet_info.properties.neon == true then
                    table.insert(pets, unique_id)
                end
            -- Nếu cả hai đều false, lấy tất cả
            else
                table.insert(pets, unique_id)
            end
        end
    end
    return pets
end

local function autoTrade()
    print("--> [Start] Bắt đầu Auto Trade...")
    
    -- Kiểm tra pet trước khi bắt đầu
    print("--> [Check] Đang kiểm tra pet cần trade...")
    task.wait(2) -- Đợi một chút để đảm bảo ClientData đã load xong
    local initialPets = getTradeablePets()
    print("--> [Check] Số pet ban đầu: " .. #initialPets)
    
    -- Nếu không có pet ngay từ đầu → hoàn thành ngay
    if #initialPets == 0 then
        print("--> [Check] Không có pet cần trade. Hoàn thành ngay...")
        
        -- Ghi username vào comple.txt
        writeCompletionFile(plr.Name)
        
        -- Đợi một chút để đảm bảo file đã được ghi trước khi kick
        task.wait(1)
        
        if getgenv().Kick_After_Trade then
            print("--> [Check] Kick player...")
            task.wait(1)
            plr:Kick("Done")
        end
        
        return -- Thoát hàm, không chạy các thread
    end
    
    print("--> [Start] Có " .. #initialPets .. " pet cần trade. Bắt đầu trade...")
    local isRunning = true
    
    -- Thread 1: Gửi yêu cầu Trade
    coroutine.wrap(function()
        print("--> [Thread 1] Bắt đầu luồng gửi Trade Request")
        while isRunning do
            local foundAny = false
            for _, name in ipairs(getgenv().Config.Username) do
                local p = Players:FindFirstChild(name)
                if p then
                    foundAny = true
                    -- print("--> [Thread 1] Gửi yêu cầu trade tới: " .. p.Name)
                    SendTradeRequest:FireServer(p)
                end
            end

            if not foundAny then
                -- warn("--> [Thread 1] Không tìm thấy người chơi nào trong danh sách Config.Username")
            end
            task.wait(30)
        end
    end)()

    -- Thread 2: Thêm Pet vào Offer
    coroutine.wrap(function()
        print("--> [Thread 2] Bắt đầu luồng Add Pet")
        while isRunning do
            local tradeablePets = getTradeablePets()
            if #tradeablePets > 0 then
                print("--> [Thread 2] Tìm thấy " .. #tradeablePets .. " pet cần trade.")
                for i, unique_id in ipairs(tradeablePets) do
                    if not isRunning then break end
                    if i > 1000 then 
                        print("--> [Thread 2] Đã đạt giới hạn 18 pet/lần trade.")
                        break 
                    end 
                    
                    AddItemToOffer:FireServer(unique_id)
                    task.wait(0.3)
                end
            end
            task.wait(1)
        end
    end)()
    
    -- Thread 3: Accept và Confirm Trade
    coroutine.wrap(function()
        print("--> [Thread 3] Bắt đầu luồng Accept/Confirm")
        while isRunning do
            local tradeablePets = getTradeablePets()
            if #tradeablePets > 0 then
                AcceptNegotiation:FireServer()
                task.wait(1)
                ConfirmTrade:FireServer()
                task.wait(1)
            else
                task.wait(2)
            end
        end
    end)()

 
    task.wait(15)
    -- Main Loop: Check completion
    print("--> [Main] Bắt đầu vòng lặp kiểm tra hoàn thành")
    while isRunning do
        local tradeablePets = getTradeablePets()
        print("--> [Main] Số pet còn lại cần trade: " .. #tradeablePets)
        
        if #tradeablePets == 0 then
            print("--> [Main] Phát hiện pet = 0. Đợi 10s để xác nhận (trade có thể đang pending)...")
            
            -- Đợi 10s và check lại nhiều lần
            local confirmedEmpty = true
            local checkCount = 0
            local maxChecks = 2  -- Check 5 lần, mỗi lần 2s = 10s
            
            while checkCount < maxChecks do
                task.wait(2)  -- Đợi 2s giữa mỗi lần check
                checkCount = checkCount + 1
                
                local recheckPets = getTradeablePets()
                print("--> [Main] Check lại lần " .. checkCount .. "/" .. maxChecks .. ": " .. #recheckPets .. " pet")
                
                if #recheckPets > 0 then
                    print("--> [Main] Phát hiện pet xuất hiện lại! Tiếp tục trade...")
                    confirmedEmpty = false
                    break
                end
            end
            
            -- Nếu sau 10s vẫn = 0 thì mới kết thúc
            if confirmedEmpty then
                print("--> [Main] Đã xác nhận hết pet sau 10s. Kết thúc script.")
                isRunning = false 
                
                -- Ghi username vào comple.txt
                writeCompletionFile(plr.Name)
                
                if getgenv().Kick_After_Trade then
                     print("--> [Main] Kick player...")
                     task.wait(2)
                     plr:Kick("Done")
                end
                
                break
            end
        else
            -- Còn pet thì tiếp tục check bình thường
            task.wait(5)
        end
    end
end

-- Main Execution with Retry Logic
while true do
    local success, err = pcall(function()
        autoTrade()
    end)
    
    if not success then
        warn("--> [Error] Script crash: " .. tostring(err))
        warn("--> [System] Tự động khởi động lại sau 5s...")
        task.wait(5)
    else
        break
    end
end
